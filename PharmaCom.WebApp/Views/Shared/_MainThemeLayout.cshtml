@inject PharmaCom.Domain.Repositories.IUnitOfWork UnitOfWork
@inject PharmaCom.Service.Interfaces.ICartService CartService
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager

@{
    var categories = await UnitOfWork.Category.GetAllAsync();
    int cartItemCount = 0;

    if (User.Identity?.IsAuthenticated == true)
    {
        var user = await UserManager.GetUserAsync(User);
        if (user != null)
        {
            var cart = await CartService.GetOrCreateUserCartAsync(user.Id);
            if (cart != null)
            {
                cartItemCount = await CartService.GetCartItemsCountAsync(cart.Id.ToString());
            }
        }
    }

    bool IsActive(string pageName)
    {
        var currentPage = ViewBag.CurrentPage as string;
        return string.Equals(currentPage, pageName, StringComparison.OrdinalIgnoreCase);
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>@ViewData["Title"] - HealX</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <link href="https://fonts.googleapis.com/css?family=Rubik:400,700|Crimson+Text:400,400i" rel="stylesheet" />
    <link rel="stylesheet" href="~/fonts/icomoon/style.css" />
    <link rel="stylesheet" href="~/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/magnific-popup.css" />
    <link rel="stylesheet" href="~/css/jquery-ui.css" />
    <link rel="stylesheet" href="~/css/owl.carousel.min.css" />
    <link rel="stylesheet" href="~/css/owl.theme.default.min.css" />
    <link rel="stylesheet" href="~/css/aos.css" />
    <link rel="stylesheet" href="~/css/style.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    @RenderSection("Styles", required: false)
</head>

<body>
    <div class="site-wrap">
        <div class="site-navbar py-2">
            <div class="search-wrap">
                <div class="container">
                    <a href="#" class="search-close js-search-close"><span class="icon-close2"></span></a>
                    <form asp-controller="Home" asp-action="Store" method="get">
                        <input type="text" name="searchTerm" class="form-control" placeholder="Search products and hit enter..." value="@((string)ViewBag.SearchTerm ?? "")" />
                    </form>
                </div>
            </div>

            <div class="container">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="logo">
                        <div class="site-logo">
                            <a asp-controller="Home" asp-action="Index" class="js-logo-clone">HealX</a>
                        </div>
                    </div>

                    <div class="main-nav d-none d-lg-block">
                        <nav class="site-navigation text-right text-md-center" role="navigation">
                            <ul class="site-menu js-clone-nav d-none d-lg-block">
                                <li class="@(IsActive("home") ? "active" : "")">
                                    <a asp-controller="Home" asp-action="Index">Home</a>
                                </li>
                                <li class="@(IsActive("store") ? "active" : "")">
                                    <a asp-controller="Home" asp-action="Store">Store</a>
                                </li>

                                @if (categories != null && categories.Any())
                                {
                                    <li class="has-children @(IsActive("categories") ? "active" : "")">
                                        <a href="#">Categories</a>
                                        <ul class="dropdown">
                                            @foreach (var category in categories.Take(10))
                                            {
                                                <li>
                                                    <a asp-controller="Home" asp-action="Store" asp-route-categoryId="@category.Id">@category.Name</a>
                                                </li>
                                            }
                                            @if (categories.Count() > 10)
                                            {
                                                <li>
                                                    <a asp-controller="Category" asp-action="Index">View All Categories</a>
                                                </li>
                                            }
                                        </ul>
                                    </li>
                                }

                                <li class="@(IsActive("about") ? "active" : "")">
                                    <a asp-controller="Home" asp-action="About">About</a>
                                </li>
                                <li class="@(IsActive("contact") ? "active" : "")">
                                    <a asp-controller="Home" asp-action="Contact">Contact</a>
                                </li>

                                @if (User.Identity?.IsAuthenticated == true)
                                {
                                    <li class="@(IsActive("order") ? "active" : "")">
                                        <a asp-controller="Order" asp-action="Index">My Orders</a>
                                    </li>

                                    @if (User.IsInRole("Admin"))
                                    {
                                        <li class="has-children">
                                            <a href="#">Admin</a>
                                            <ul class="dropdown">
                                                <li><a asp-controller="Dashboard" asp-action="Index">Dashboard</a></li>
                                            </ul>
                                        </li>
                                    }
                                    @if (User.IsInRole("Pharmacist"))
                                    {
                                        <li class="has-children">
                                            <a href="#">Pharmacist</a>
                                            <ul class="dropdown">
                                                <li><a asp-controller="Dashboard" asp-action="Index">Dashboard</a></li>
                                            </ul>
                                        </li>
                                    }
                                }
                            </ul>
                        </nav>
                    </div>

                    <div class="icons">
                        <a href="#" class="icons-btn d-inline-block js-search-open">
                            <span class="icon-search"></span>
                        </a>

                        <a asp-controller="Cart" asp-action="Index" class="icons-btn d-inline-block bag">
                            <span class="icon-shopping-bag"></span>
                            <span class="number" id="cart-count">@cartItemCount</span>
                        </a>

                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <div class="user-account-dropdown d-inline-block" style="position: relative;">
                                <a href="#" class="icons-btn d-inline-block user-account-toggle" title="Account">
                                    <span class="icon-person"></span>
                                </a>
                                <ul class="dropdown user-dropdown">
                                    <li>
                                        <a asp-controller="Account" asp-action="Profile">Profile</a>
                                    </li>
                                    <li>
                                        <a asp-controller="Account" asp-action="SignOut">Logout</a>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <a asp-controller="Account" asp-action="Login" class="icons-btn d-inline-block" title="Login">
                                <span class="icon-person"></span>
                            </a>
                        }

                        <a href="#" class="site-menu-toggle js-menu-toggle ml-3 d-inline-block d-lg-none">
                            <span class="icon-menu"></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        @RenderSection("Breadcrumb", required: false)

        <main>
            @RenderBody()
        </main>

        @RenderSection("PromoBanner", required: false)

        <footer class="site-footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-4 mb-lg-0">
                        <div class="block-7">
                            <h3 class="footer-heading mb-4">About Us</h3>
                            <p>HealX is your trusted online pharmacy providing quality medications and healthcare products with fast, reliable delivery.</p>
                        </div>
                    </div>

                    <div class="col-lg-3 mx-auto mb-5 mb-lg-0">
                        <h3 class="footer-heading mb-4">Quick Links</h3>
                        <ul class="list-unstyled">
                            <li><a asp-controller="Product" asp-action="Index">All Products</a></li>
                            <li><a asp-controller="Home" asp-action="About">About Us</a></li>
                            <li><a asp-controller="Home" asp-action="Contact">Contact</a></li>
                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                <li><a asp-controller="Order" asp-action="Index">My Orders</a></li>
                            }
                            else
                            {
                                <li><a asp-page="/Account/Register">Register</a></li>
                            }
                        </ul>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <div class="block-5 mb-5">
                            <h3 class="footer-heading mb-4">Contact Info</h3>
                            <ul class="list-unstyled">
                                <li class="address">Cairo, Egypt</li>
                                <li class="phone"><a href="tel://+20 223929210">+20 223929210</a></li>
                                <li class="email"><a href="mailto:info@healx.com">info@healx.com</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                
            </div>
        </footer>
    </div>

    <script src="~/js/jquery-3.3.1.min.js"></script>
    <script src="~/js/jquery-ui.js"></script>
    <script src="~/js/popper.min.js"></script>
    <script src="~/js/bootstrap.min.js"></script>
    <script src="~/js/owl.carousel.min.js"></script>
    <script src="~/js/jquery.magnific-popup.min.js"></script>
    <script src="~/js/aos.js"></script>
    <script src="~/js/main.js"></script>
    <script>
        $(document).ready(function () {
            updateCartCount();
        });

        function updateCartCount() {
            $.get('@Url.Action("GetCartCount", "Cart")', function (response) {
                if (response.success) {
                    $('#cart-count').text(response.count);
                }
            });
        }
    </script>
    @RenderSection("Scripts", required: false)
</body>
</html>