@using System.Linq
@model PagedResult<Product>

@{
    Layout = "~/Views/Shared/_MainThemeLayout.cshtml";
    ViewData["Title"] = "Store";
    ViewBag.CurrentPage = "store";

    // Filter Variables
    int? categoryId = ViewBag.CurrentCategory as int?;
    string? brand = ViewBag.CurrentBrand as string;
    string? form = ViewBag.CurrentForm as string;
    decimal? minPrice = ViewBag.MinPrice as decimal?;
    decimal? maxPrice = ViewBag.MaxPrice as decimal?;
    string sortBy = ViewBag.SortBy as string ?? "Name";
    bool sortDesc = ViewBag.CurrentDesc ?? false;
}

<div class="site-section bg-light">
    <div class="container">

        <div class="row mb-3 d-lg-none">
            <div class="col-12">
                <button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#filterSection" aria-expanded="false">
                    <span class="icon-filter"></span> Show Filters
                </button>
            </div>
        </div>

        <div class="collapse d-lg-block" id="filterSection">
            <form asp-controller="Home" asp-action="Store" method="get" class="mb-5 p-4 bg-white rounded shadow-sm">
                <div class="row gap-3 align-items-end justify-content-center">

                    <div class="col-md-6 col-lg mb-3 mb-lg-0">
                        <label for="categoryId" class="text-black mb-2"><small><strong>Category</strong></small></label>
                        <select name="categoryId" id="categoryId" class="form-select custom-red-dropdown">
                            <option value="">All Categories</option>
                            @foreach (var cat in ViewBag.Categories ?? new List<dynamic>())
                            {
                                <option value="@cat.Id" selected="@(categoryId == cat.Id)">@cat.Name</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6 col-lg mb-3 mb-lg-0">
                        <label for="brand" class="text-black mb-2"><small><strong>Brand</strong></small></label>
                        <select name="brand" id="brand" class="form-select custom-red-dropdown">
                            <option value="">All Brands</option>
                            @foreach (var b in ViewBag.Brands ?? new List<string>())
                            {
                                <option value="@b" selected="@(brand == b)">@b</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6 col-lg mb-3 mb-lg-0">
                        <label for="form" class="text-black mb-2"><small><strong>Form</strong></small></label>
                        <select name="form" id="form" class="form-select custom-red-dropdown">
                            <option value="">All Forms</option>
                            @foreach (var f in ViewBag.Forms ?? new List<string>())
                            {
                                <option value="@f" selected="@(form == f)">@f</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6 col-lg mb-3 mb-lg-0">
                        <label class="text-black mb-2"><small><strong>Price Range</strong></small></label>
                        <div class="d-flex gap-1">
                            <input type="number" name="minPrice" class="form-control" placeholder="Min" value="@minPrice" min="0" />
                            <input type="number" name="maxPrice" class="form-control" placeholder="Max" value="@maxPrice" min="0" />
                        </div>
                    </div>

                    <div class="col-md-6 col-lg mb-3 mb-lg-0">
                        <label for="sortOption" class="text-black mb-2"><small><strong>Sort By</strong></small></label>
                        <select name="sortOption" id="sortOption" class="form-select custom-red-dropdown">
                            <option value="Name-false" selected="@(sortBy == "Name" && !sortDesc)">Name (A-Z)</option>
                            <option value="Name-true" selected="@(sortBy == "Name" && sortDesc)">Name (Z-A)</option>
                            <option value="Price-false" selected="@(sortBy == "Price" && !sortDesc)">Price (Low-High)</option>
                            <option value="Price-true" selected="@(sortBy == "Price" && sortDesc)">Price (High-Low)</option>
                            <option value="Newest-true" selected="@(sortBy == "Newest")">Newest</option>
                        </select>
                    </div>

                    <div class="col-md-12 col-lg-auto d-flex gap-2 mb-3 mb-lg-0">
                        <button type="submit" class="btn btn-primary px-4">Filter</button>
                        <a asp-controller="Home" asp-action="Store" class="btn btn-outline-primary px-4">Reset</a>
                    </div>
                </div>
            </form>
        </div>

        <div class="row mb-4">
            <div class="col-12 text-center">
                <span class="text-muted">
                    Showing <strong>@((Model.PageNumber - 1) * Model.PageSize + 1) - @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount))</strong> of <strong>@Model.TotalCount</strong> products
                </span>
            </div>
        </div>

        @if (Model.Items != null && Model.Items.Any())
        {
            <div class="row">
                @foreach (var product in Model.Items)
                {
                    <div class="col-md-6 col-lg-4 mb-5">
                        <div class="card product-card h-100 border-0 position-relative">
                            @if (product.IsRxRequired)
                            {
                                <div class="badge bg-danger rounded-pill position-absolute m-2" style="top:0; left:0; z-index:10;">Rx Required</div>
                            }

                            <div class="card-img-wrapper p-3 text-center" style="height: 250px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                <a asp-controller="Home" asp-action="ShowProduct" asp-route-id="@product.Id">
                                    <img src="@(product.ImageURLString ?? "/images/product_placeholder.png")"
                                         class="card-img-top img-fluid product-img"
                                         alt="@product.Name"
                                         onerror="this.onerror=null;this.src='/images/product_placeholder.png';" />
                                </a>
                            </div>

                            <div class="card-body text-center d-flex flex-column pt-4">
                                <h5 class="card-title mb-2">
                                    <a asp-controller="Home" asp-action="ShowProduct" asp-route-id="@product.Id" class="text-dark fw-bold text-decoration-none">
                                        @product.Name
                                    </a>
                                </h5>

                                <div class="mt-auto">
                                    <p class="price fs-5 fw-bold mb-3" style="color: var(--pharma-red);">
                                        $@product.Price.ToString("F2")
                                    </p>

                                    <form asp-controller="Cart" asp-action="AddItem" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="productId" value="@product.Id" />
                                        <input type="hidden" name="quantity" value="1" />
                                        <button type="submit" class="btn btn-custom-red rounded-pill px-4 w-100">
                                            Add to cart
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-12 text-center py-5">
                    <h3 class="text-muted">No products found</h3>
                    <p>Try adjusting your filters</p>
                    <a asp-controller="Home" asp-action="Store" class="btn btn-primary mt-3">View All Products</a>
                </div>
            </div>
        }

        @if (Model.TotalPages > 1)
        {
            <div class="row mt-5">
                <div class="col-md-12 text-center">
                    <div class="site-block-27">
                        <ul>
                            @if (Model.HasPrevious)
                            {
                                <li>
                                    <a asp-action="Store"
                                       asp-route-page="@(Model.PageNumber - 1)"
                                       asp-route-searchTerm="@ViewBag.SearchTerm"
                                       asp-route-categoryId="@ViewBag.CurrentCategory"
                                       asp-route-brand="@ViewBag.CurrentBrand"
                                       asp-route-form="@ViewBag.CurrentForm"
                                       asp-route-minPrice="@ViewBag.MinPrice"
                                       asp-route-maxPrice="@ViewBag.MaxPrice"
                                       asp-route-sort="@ViewBag.SortBy"
                                       asp-route-desc="@ViewBag.CurrentDesc">&lt;</a>
                                </li>
                            }
                            else
                            {
                                <li class="disabled"><span>&lt;</span></li>
                            }

                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="@(i == Model.PageNumber ? "active" : "")">
                                    @if (i == Model.PageNumber)
                                    {
                                        <span>@i</span>
                                    }
                                    else
                                    {
                                        <a asp-action="Store"
                                           asp-route-page="@i"
                                           asp-route-searchTerm="@ViewBag.SearchTerm"
                                           asp-route-categoryId="@ViewBag.CurrentCategory"
                                           asp-route-brand="@ViewBag.CurrentBrand"
                                           asp-route-form="@ViewBag.CurrentForm"
                                           asp-route-minPrice="@ViewBag.MinPrice"
                                           asp-route-maxPrice="@ViewBag.MaxPrice"
                                           asp-route-sort="@ViewBag.SortBy"
                                           asp-route-desc="@ViewBag.CurrentDesc">@i</a>
                                    }
                                </li>
                            }

                            @if (Model.HasNext)
                            {
                                <li>
                                    <a asp-action="Store"
                                       asp-route-page="@(Model.PageNumber + 1)"
                                       asp-route-searchTerm="@ViewBag.SearchTerm"
                                       asp-route-categoryId="@ViewBag.CurrentCategory"
                                       asp-route-brand="@ViewBag.CurrentBrand"
                                       asp-route-form="@ViewBag.CurrentForm"
                                       asp-route-minPrice="@ViewBag.MinPrice"
                                       asp-route-maxPrice="@ViewBag.MaxPrice"
                                       asp-route-sort="@ViewBag.SortBy"
                                       asp-route-desc="@ViewBag.CurrentDesc">&gt;</a>
                                </li>
                            }
                            else
                            {
                                <li class="disabled"><span>&gt;</span></li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(function() {
            // Handle sort dropdown to split SortBy and Descending values
            $('#sortOption').on('change', function() {
                var val = $(this).val();
                if (val) {
                    var parts = val.split('-');
                    var form = $(this).closest('form');
                    form.find('input[name="sort"]').remove();
                    form.find('input[name="desc"]').remove();
                    form.append('<input type="hidden" name="sort" value="' + parts[0] + '">');
                    form.append('<input type="hidden" name="desc" value="' + parts[1] + '">');
                }
            });
        });
    </script>
}