@model CheckoutViewModel

@{
    Layout = "~/Views/Shared/_MainThemeLayout.cshtml";
    ViewData["Title"] = "Checkout";
    ViewBag.CurrentPage = "checkout";
}

@section Styles {
    <style>
        :root {
            --pharma-red: #8B0000;
        }

        .custom-file-input {
            display: none; 
        }

        /* === General Layout === */
        .checkout-section {
            background-color: #f8f9fa;
            padding-bottom: 5rem;
        }

        .section-title {
            font-weight: 700;
            color: #212529;
            letter-spacing: -0.5px;
        }

        /* === Order Summary Item === */
        .order-summary-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 16px;
            overflow: hidden;
        }

        .summary-item {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid #f1f3f5;
            transition: background-color 0.2s;
        }

            .summary-item:last-child {
                border-bottom: none;
            }

            .summary-item:hover {
                background-color: #fafafa;
            }

        .product-thumb {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #eee;
            margin-right: 1.25rem;
            flex-shrink: 0;
        }

            .product-thumb img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

        .item-details h6 {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #212529;
        }

        .price-tag {
            font-weight: 700;
            color: var(--pharma-red);
        }

        .qty-badge {
            background-color: #e9ecef;
            color: #495057;
            font-size: 0.75rem;
            padding: 0.2em 0.6em;
            border-radius: 6px;
            font-weight: 600;
            margin-left: 8px;
        }

        .rx-badge {
            font-size: 0.7rem;
            color: #dc3545;
            background-color: #ffebee;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            margin-top: 4px;
            font-weight: 600;
        }

        /* === Upload Zone === */
        .upload-zone-card {
            border: 2px dashed #dee2e6!important;
            border-radius: 16px;
            background-color: #fff;
            transition: all 0.3s ease;
        }

            .upload-zone-card:hover {
                border-color: var(--pharma-red)!important;
                background-color: #fffbfc;
            }

        .custom-file-label {
            border-radius: 50px;
            height: auto;
            padding: 0.75rem 1.5rem;
            border: 1px solid #ced4da;
            cursor: pointer;
        }
            .custom-file-label:hover{
                border: 1px solid #8B0000;
            }

            .custom-file-label::after {
                display: none;
            }

        /* === Totals Card === */
        .totals-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            position: sticky;
            top: 100px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #495057;
        }

        .final-total {
            border-top: 2px dashed #e9ecef;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .final-total span {
                font-size: 1.1rem;
                font-weight: 700;
                color: #212529;
            }

            .final-total strong {
                font-size: 1.75rem;
                color: var(--pharma-red);
                font-weight: 800;
            }

        /* === Payment Button Styling (Red Theme) === */
        .btn-primary {
            background-color: var(--pharma-red) !important;
            border-color: var(--pharma-red) !important;
            color: #fff !important;
            font-weight: 600;
            padding: 1rem;
            border-radius: 50px; /* Keep consistent roundness */
            box-shadow: 0 4px 6px rgba(139, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

            .btn-primary:hover, .btn-primary:focus {
                background-color: #fff !important;
                color:#8B0000;
                border-color: #680000 !important;
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(139, 0, 0, 0.25);
            }

            .btn-primary:disabled {
                background-color: #6c757d !important;
                border-color: #6c757d !important;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

        /* Loading animation */
        .icon-loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
}

@section Breadcrumb {
    <div class="bg-light py-3">
        <div class="container">
            <div class="row">
                <div class="col-md-12 mb-0">
                    <a asp-controller="Home" asp-action="Index" class="text-decoration-none text-muted">Home</a>
                    <span class="mx-2 mb-0">/</span>
                    <a asp-controller="Cart" asp-action="Index" class="text-decoration-none text-muted">Cart</a>
                    <span class="mx-2 mb-0">/</span>
                    <strong class="text-black">Checkout</strong>
                </div>
            </div>
        </div>
    </div>
}

<div class="site-section checkout-section pt-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-12">
                <h2 class="h3 section-title text-uppercase">Checkout</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-7 mb-5 mb-lg-0">

                <div class="mb-4">
                    <h5 class="text-black mb-3 font-weight-bold">Order Summary</h5>
                    <div class="order-summary-card shadow-sm">
                        @foreach (var item in Model.CartItems)
                        {
                            <div class="summary-item">
                                <div class="product-thumb">
                                    <img src="@(item.Product.ImageURLString ?? "/images/product_placeholder.png")"
                                         alt="@item.Product.Name">
                                </div>

                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                @item.Product.Name
                                                <span class="qty-badge">x @item.Quantity</span>
                                            </h6>
                                            @if (item.Product.IsRxRequired)
                                            {
                                                <span class="rx-badge">
                                                    <i class="icon-file-text mr-1"></i> Rx Required
                                                </span>
                                            }
                                        </div>
                                        <div class="text-right">
                                            <div class="price-tag">$@((item.Product.Price * item.Quantity).ToString("F2"))</div>
                                            <small class="text-muted d-block">$@item.Product.Price.ToString("F2") / unit</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @if (Model.RequiresPrescription)
                {
                    <div class="mt-5">
                        <h5 class="text-black mb-3 font-weight-bold d-flex align-items-center text-danger">
                            <span class="icon-alert-circle mr-2"></span> Prescription Required
                        </h5>

                        <div class="upload-zone-card p-4">
                            <div class="text-center mb-4">
                                <p class="text-muted mb-0">Some items in your cart require a valid prescription.</p>
                                <p class="small text-muted">Please upload a clear photo or PDF.</p>
                            </div>

                            <form id="prescriptionUploadForm" enctype="multipart/form-data">
                                @Html.AntiForgeryToken()
                                <input type="hidden" id="tempPrescriptionId" name="tempPrescriptionId" value="" />

                                <div class="form-group mb-3 text-center">
                                    <div class="custom-file" style="max-width: 400px; margin: 0 auto;">
                                        <input type="file" class="custom-file-input" id="prescriptionFile" name="prescriptionFile" accept=".jpg,.jpeg,.png,.pdf" required>
                                        <label class="custom-file-label text-left" for="prescriptionFile">
                                            <i class="icon-upload mr-2 text-primary"></i> Choose file...
                                        </label>
                                    </div>
                                </div>

                                <div id="prescriptionPreview" class="mt-3" style="display:none;">
                                    <div class="d-flex align-items-center justify-content-center bg-light p-3 rounded-lg border">
                                        <i class="icon-file-text mr-2 text-primary" style="font-size: 1.5rem;"></i>
                                        <div>
                                            <span id="fileName" class="font-weight-bold text-dark"></span>
                                            <span id="fileSize" class="text-muted ml-2 small"></span>
                                        </div>
                                        <button type="button" class="btn btn-sm text-danger ml-3" id="clearFile" title="Remove">
                                            <i class="icon-close"></i>
                                        </button>
                                    </div>
                                </div>

                                <div id="uploadStatus" class="mt-3" style="display:none;">
                                    <div class="alert rounded-lg mb-0" id="uploadMessage"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                }
            </div>

            <div class="col-lg-5">
                <div class="totals-card shadow-sm">
                    <h5 class="text-black mb-4 font-weight-bold">Payment Details</h5>

                    <div class="mb-4 pb-4 border-bottom">
                        <h6 class="text-muted text-uppercase small font-weight-bold mb-3">Shipping To</h6>
                        <div class="d-flex">
                            <span class="icon-map-marker text-primary mt-1 mr-3"></span>
                            <address class="mb-0 text-black">
                                <strong>@Model.ShippingAddress.Line1</strong><br>
                                @Model.ShippingAddress.City, @Model.ShippingAddress.Governorate
                            </address>
                        </div>
                    </div>

                    <div class="total-row">
                        <span>Subtotal</span>
                        <span class="font-weight-bold text-black">$@Model.TotalAmount.ToString("F2")</span>
                    </div>
                    <div class="total-row">
                        <span>Shipping</span>
                        <span class="text-success font-weight-bold">Free</span>
                    </div>

                    <div class="final-total">
                        <span>Total Amount</span>
                        <strong>$@Model.TotalAmount.ToString("F2")</strong>
                    </div>

                    <form id="checkoutForm" asp-action="ProcessCheckout" asp-controller="Order" method="post" class="mt-4">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="prescriptionId" id="hiddenPrescriptionId" value="" />

                        @if (Model.RequiresPrescription)
                        {
                            <button type="submit" id="proceedToPayment" class="btn btn-primary btn-lg btn-block w-100" disabled>
                                <i class="icon-lock me-2"></i> Upload Prescription First
                            </button>
                        }
                        else
                        {
                            <button type="submit" id="proceedToPayment" class="btn btn-primary btn-lg btn-block w-100">
                                <i class="icon-credit-card me-2"></i> Proceed to Payment
                            </button>
                        }
                    </form>

                    <div class="mt-4 text-center">
                        <a asp-controller="Cart" asp-action="Index" class="text-muted text-decoration-none small">
                            <i class="icon-arrow-left mr-1"></i> Return to Cart
                        </a>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="icon-shield mr-1"></i> Secure Encrypted Payment
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            var requiresPrescription = @Model.RequiresPrescription.ToString().ToLower();
            var prescriptionUploaded = false;

            // Handle file selection
            $('#prescriptionFile').on('change', function() {
                var file = this.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB');
                        this.value = '';
                        return;
                    }

                    $(this).next('.custom-file-label').text(file.name);
                    $('#fileName').text(file.name);
                    $('#fileSize').text('(' + (file.size / 1024).toFixed(2) + ' KB)');
                    $('#prescriptionPreview').slideDown();

                    uploadPrescription();
                }
            });

            // Clear file
            $('#clearFile').on('click', function() {
                $('#prescriptionFile').val('');
                $('.custom-file-label').html('<i class="icon-upload mr-2 text-primary"></i> Choose file...');
                $('#prescriptionPreview').slideUp();
                $('#tempPrescriptionId').val('');
                $('#hiddenPrescriptionId').val('');
                $('#uploadStatus').hide();
                prescriptionUploaded = false;
                updatePaymentButton();
            });

            function uploadPrescription() {
                var formData = new FormData();
                var file = $('#prescriptionFile')[0].files[0];
                if (!file) return;

                formData.append('file', file);
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                $('#uploadStatus').show();
                $('#uploadMessage').removeClass('alert-success alert-danger').addClass('alert-info').html('<i class="icon-loading mr-2"></i> Uploading...');

                $.ajax({
                    url: '@Url.Action("UploadPrescriptionForCheckout", "Prescription")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#uploadMessage').removeClass('alert-info').addClass('alert-success')
                                .html('<i class="icon-check mr-2"></i> Uploaded successfully');

                            prescriptionUploaded = true;
                            $('#tempPrescriptionId').val(response.prescriptionId);
                            $('#hiddenPrescriptionId').val(response.prescriptionId);
                            updatePaymentButton();
                        } else {
                            $('#uploadMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                            prescriptionUploaded = false;
                            updatePaymentButton();
                        }
                    },
                    error: function() {
                        $('#uploadMessage').removeClass('alert-info').addClass('alert-danger').text('Upload failed. Try again.');
                        prescriptionUploaded = false;
                        updatePaymentButton();
                    }
                });
            }

            function updatePaymentButton() {
                var $button = $('#proceedToPayment');
                if (!requiresPrescription || prescriptionUploaded) {
                    $button.prop('disabled', false)
                           .html('<i class="icon-credit-card me-2"></i> Proceed to Payment');
                } else {
                    $button.prop('disabled', true)
                           .html('<i class="icon-lock me-2"></i> Upload Prescription First');
                }
            }

            $('#checkoutForm').on('submit', function(e) {
                e.preventDefault();
                var $button = $('#proceedToPayment');
                var prescriptionId = $('#hiddenPrescriptionId').val();

                if (requiresPrescription && !prescriptionId) {
                    alert('Please upload a prescription.');
                    return false;
                }

                // Show processing state
                $button.prop('disabled', true).html('<i class="icon-loading me-2"></i> Processing...');

                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: {
                        prescriptionId: prescriptionId || null,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success && response.redirectUrl) {
                            window.location.href = response.redirectUrl;
                        } else {
                            alert('Error: ' + response.message);
                            // Reset button on error
                            $button.prop('disabled', false).html('<i class="icon-credit-card me-2"></i> Proceed to Payment');
                        }
                    },
                    error: function() {
                        alert('Connection error. Please try again.');
                        $button.prop('disabled', false).html('<i class="icon-credit-card me-2"></i> Proceed to Payment');
                    }
                });
            });

            updatePaymentButton();
        });
    </script>
}