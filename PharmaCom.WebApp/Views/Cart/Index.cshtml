@model Cart

@{
    Layout = "~/Views/Shared/_MainThemeLayout.cshtml";
    ViewData["Title"] = "Shopping Cart";
    ViewBag.CurrentPage = "cart";
    decimal cartTotal = ViewBag.CartTotal ?? 0m;
    bool hasRxProducts = Model?.Items?.Any(i => i.Product.IsRxRequired) ?? false;
}

<style>
    .cart-container {
        background-color: #f8f9fa;
        padding-bottom: 5rem;
    }

    .cart-header {
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 1px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
    }

    .cart-item-row {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        margin-bottom: 1rem;
        transition: transform 0.2s;
    }

        .cart-item-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

    .product-img-box {
        width: 100px;
        height: 100px;
        border-radius: 10px;
        overflow: hidden;
        background: #f1f3f5;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .product-img-box img {
            max-height: 100%;
            width: auto;
        }

    .quantity-wrapper {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 50px;
        padding: 5px;
        width: fit-content;
    }

    .qty-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: #6c757d;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

        .qty-btn:hover {
            background: #8B0000;
        }

    .qty-input {
        width: 40px;
        background: transparent;
        border: none;
        text-align: center;
        font-weight: bold;
        color: #6c757d;
    }

    .btn-remove-item {
        color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        border: none;
    }

        .btn-remove-item:hover {
            background: #dc3545;
            color: #fff;
        }

    .cart-summary-card {
        background: #fff;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #eee;
    }

    .rx-badge {
        background-color: #ffebee;
        color: #c62828;
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    /* === ستايل زر الرجوع الجديد === */
    .btn-outline-dark-red {
        color: #8B0000;
        border: 1px solid #8B0000;
        background-color: transparent;
        transition: all 0.3s ease;
    }

        .btn-outline-dark-red:hover {
            background-color: #8B0000;
            color: #fff !important;
            border-color: #8B0000;
            text-decoration: none;
        }
</style>

@section Breadcrumb {
    <div class="bg-light py-3">
        <div class="container">
            <div class="row">
                <div class="col-md-12 mb-0">
                    <a asp-controller="Home" asp-action="Index" class="text-decoration-none text-muted">Home</a>
                    <span class="mx-2 mb-0">/</span>
                    <strong class="text-black">Shopping Cart</strong>
                </div>
            </div>
        </div>
    </div>
}

<div class="site-section cart-container pt-5">
    <div class="container">
        @if (Model?.Items != null && Model.Items.Any())
        {
            @if (hasRxProducts)
            {
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-warning border-0 shadow-sm rounded-4 d-flex align-items-center" role="alert">
                            <span class="icon-info me-3 text-warning" style="font-size: 24px;"></span>
                            <div>
                                <h6 class="alert-heading fw-bold mb-1">Prescription Required</h6>
                                <p class="mb-0 small text-muted">Some items require a prescription. You can upload it during checkout.</p>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <div class="row">
                <div class="col-lg-8 mb-5 mb-lg-0">
                    <div class="d-none d-md-flex row mb-3 cart-header mx-0">
                        <div class="col-md-5">Product</div>
                        <div class="col-md-2 text-center">Price</div>
                        <div class="col-md-3 text-center">Quantity</div>
                        <div class="col-md-2 text-end">Total</div>
                    </div>

                    @foreach (var item in Model.Items)
                    {
                        var itemTotal = item.Product.Price * item.Quantity;
                        <div class="row align-items-center cart-item-row p-3 mx-0 position-relative" data-product-id="@item.ProductId">

                            <div class="d-md-none position-absolute top-0 end-0 p-2">
                                <button class="btn-remove-item btn-sm btn-remove" data-product-id="@item.ProductId">
                                    <span class="icon-trash"></span>
                                </button>
                            </div>

                            <div class="col-12 col-md-5 d-flex align-items-center gap-3 mb-3 mb-md-0">
                                <div class="product-img-box flex-shrink-0">
                                    <img src="@(item.Product.ImageURLString ?? "/images/product_placeholder.png")" alt="@item.Product.Name" class="img-fluid">
                                </div>
                                <div>
                                    <h5 class="h6 text-black mb-1 fw-bold">
                                        <a asp-controller="Home" asp-action="ShowProduct" asp-route-id="@item.ProductId" class="text-dark text-decoration-none">
                                            @item.Product.Name
                                        </a>
                                    </h5>
                                    @if (item.Product.IsRxRequired)
                                    {
                                        <span class="rx-badge mt-1">
                                            <i class="icon-file-text"></i> Rx Required
                                        </span>
                                    }
                                </div>
                            </div>

                            <div class="col-6 col-md-2 text-md-center">
                                <span class="d-md-none text-muted small">Price: </span>
                                <span class="fw-bold text-dark item-price">$@item.Product.Price.ToString("F2")</span>
                            </div>

                            <div class="col-6 col-md-3 d-flex justify-content-end justify-content-md-center">
                                <div class="quantity-wrapper">
                                    <button class="qty-btn js-btn-minus" type="button" data-product-id="@item.ProductId">&minus;</button>
                                    <input type="text" class="qty-input quantity-input" value="@item.Quantity" readonly data-product-id="@item.ProductId">
                                    <button class="qty-btn js-btn-plus" type="button" data-product-id="@item.ProductId">&plus;</button>
                                </div>
                            </div>

                            <div class="col-12 col-md-2 d-flex align-items-center justify-content-between justify-content-md-end mt-3 mt-md-0 pt-3 pt-md-0 border-top border-md-0">
                                <div class="d-md-none fw-bold">Subtotal:</div>
                                <div class="fw-bold text-primary item-total">$@itemTotal.ToString("F2")</div>

                                <div class="d-none d-md-block ms-3">
                                    <button class="btn-remove-item btn-remove" data-product-id="@item.ProductId">
                                        <span class="icon-trash"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <a asp-controller="Home" asp-action="Store" class="btn btn-outline-dark-red rounded-pill px-4">
                                <i class="icon-arrow-left mr-2"></i> Continue Shopping
                            </a>
                        </div>
                        <div class="col-md-6 text-md-right">
                            <form asp-action="Clear" method="post" onsubmit="return confirm('Are you sure you want to clear your cart?');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-outline-danger rounded-pill px-4">
                                    <i class="icon-trash mr-2"></i> Clear Cart
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="cart-summary-card sticky-top" style="top: 100px;">
                        <h3 class="h5 text-black text-uppercase fw-bold mb-4">Order Summary</h3>

                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">Subtotal</span>
                            <strong class="text-black" id="cart-subtotal">$@cartTotal.ToString("F2")</strong>
                        </div>

                        <div class="d-flex justify-content-between mb-4">
                            <span class="text-black fw-bold h5">Total</span>
                            <strong class="text-primary h4" id="cart-total">$@cartTotal.ToString("F2")</strong>
                        </div>

                        <a asp-controller="Order" asp-action="Checkout" class="btn btn-primary btn-lg rounded-pill w-100 py-3 shadow-sm mb-3">
                            <span class="icon-arrow-right mr-2"></span> Proceed To Checkout
                        </a>

                        @if (hasRxProducts)
                        {
                            <div class="text-center bg-light p-2 rounded-3">
                                <small class="text-muted d-block">
                                    <i class="icon-upload mr-1"></i> Prescription upload in next step
                                </small>
                            </div>
                        }

                        <div class="mt-4 text-center">
                            <small class="text-muted">
                                <i class="icon-shield mr-1"></i> Secure Checkout
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row justify-content-center">
                <div class="col-md-6 text-center py-5">
                    <div class="mb-4">
                        <span class="icon-shopping-bag display-1 text-muted opacity-25"></span>
                    </div>
                    <h3 class="text-black fw-bold mb-3">Your Cart is Empty</h3>
                    <p class="text-muted mb-4">Looks like you haven't added anything to your cart yet.</p>
                    <a asp-controller="Home" asp-action="Store" class="btn btn-primary rounded-pill px-5 py-3 shadow-sm">
                        Start Shopping Now
                    </a>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Unbind previous handlers to avoid duplicates
            $('.js-btn-plus, .js-btn-minus, .btn-remove').off();

            // === Handle Quantity Increase ===
            $(document).on('click', '.js-btn-plus', function (e) {
                e.preventDefault();
                var productId = $(this).data('product-id');
                var $input = $('.quantity-input[data-product-id="' + productId + '"]');
                var currentQty = parseInt($input.val()) || 0;
                var newQty = currentQty + 1;
                $input.val(newQty);
                updateQuantity(productId, newQty, $input);
            });

            // === Handle Quantity Decrease ===
            $(document).on('click', '.js-btn-minus', function (e) {
                e.preventDefault();
                var productId = $(this).data('product-id');
                var $input = $('.quantity-input[data-product-id="' + productId + '"]');
                var currentQty = parseInt($input.val()) || 0;
                if (currentQty > 1) {
                    var newQty = currentQty - 1;
                    $input.val(newQty);
                    updateQuantity(productId, newQty, $input);
                }
            });

            // === Handle Remove Item ===
            $(document).on('click', '.btn-remove', function (e) {
                e.preventDefault();
                var productId = $(this).data('product-id');
                if (confirm('Are you sure you want to remove this item?')) {
                    removeItem(productId);
                }
            });

            // AJAX: Update Quantity
            function updateQuantity(productId, quantity, $input) {
                $.ajax({
                    url: '@Url.Action("UpdateQuantity", "Cart")',
                    type: 'POST',
                    data: {
                        productId: productId,
                        quantity: quantity,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            var $row = $('.cart-item-row[data-product-id="' + productId + '"]');
                            var price = parseFloat($row.find('.item-price').text().replace('$', ''));
                            var itemTotal = price * quantity;
                            $row.find('.item-total').text('$' + itemTotal.toFixed(2));

                            $('#cart-subtotal').text('$' + response.cartTotal);
                            $('#cart-total').text('$' + response.cartTotal);

                            if (typeof updateCartCount === 'function') {
                                updateCartCount();
                            }
                        } else {
                            alert('Error: ' + response.message);
                            location.reload();
                        }
                    },
                    error: function () {
                        alert('Connection error. Please try again.');
                    }
                });
            }

            // AJAX: Remove Item
            function removeItem(productId) {
                $.ajax({
                    url: '@Url.Action("RemoveItem", "Cart")',
                    type: 'POST',
                    data: {
                        productId: productId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            var $row = $('.cart-item-row[data-product-id="' + productId + '"]');
                            $row.fadeOut(300, function() {
                                $(this).remove();
                                $('#cart-subtotal').text('$' + response.cartTotal);
                                $('#cart-total').text('$' + response.cartTotal);

                                if (response.itemCount === 0) {
                                    location.reload();
                                } else {
                                    if (typeof updateCartCount === 'function') {
                                        updateCartCount();
                                    }
                                }
                            });
                        } else {
                            alert('Error removing item: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Connection error. Please try again.');
                    }
                });
            }
        });
    </script>
}