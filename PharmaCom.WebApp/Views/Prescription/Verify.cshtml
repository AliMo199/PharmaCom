@model IEnumerable<PrescriptionViewModel>
@{
    ViewData["Title"] = "Verify Prescriptions";
    Layout = "_DashboardLayout";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Prescription Verification</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/Dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">Prescription Verification</li>
    </ol>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-prescription me-1"></i>
            Pending Prescriptions
        </div>
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="alert alert-info mb-0">
                    No pending prescriptions to verify at this time.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Upload Date</th>
                                <th>Products Requiring Rx</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var prescription in Model)
                            {
                                <tr>
                                    <td>@prescription.PrescriptionId</td>
                                    <td>
                                        <a href="@Url.Action("Details", "Order", new { id = prescription.OrderId })">
                                            @prescription.OrderId
                                        </a>
                                    </td>
                                    <td>@prescription.CustomerName</td>
                                    <td>@prescription.UploadDate.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>
                                        @if (prescription.PrescriptionProducts.Any())
                                        {
                                            <ul class="mb-0 ps-3">
                                                @foreach (var product in prescription.PrescriptionProducts)
                                                {
                                                    <li>@product.Name (x@product.Quantity)</li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No Rx-required products</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-info view-prescription"
                                                    data-prescription-id="@prescription.PrescriptionId"
                                                    data-prescription-url="@prescription.FileUrl">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            <button type="button" class="btn btn-sm btn-success verify-prescription"
                                                    data-prescription-id="@prescription.PrescriptionId"
                                                    data-order-id="@prescription.OrderId">
                                                <i class="fas fa-check"></i> Verify
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Prescription View Modal -->
<div class="modal fade" id="prescriptionViewModal" tabindex="-1" aria-labelledby="prescriptionViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prescriptionViewModalLabel">View Prescription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <!-- Dynamic content will be loaded here -->
                    <div id="prescriptionImageContainer" class="d-none">
                        <img id="prescriptionImage" src="" class="img-fluid" alt="Prescription" />
                    </div>
                    <div id="prescriptionPdfContainer" class="d-none">
                        <iframe id="prescriptionPdf" src="" width="100%" height="600px" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="prescriptionDownloadBtn" href="#" class="btn btn-primary" download>
                    <i class="fas fa-download"></i> Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Prescription Verification Modal -->
<div class="modal fade" id="verificationModal" tabindex="-1" aria-labelledby="verificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="verificationModalLabel">Verify Prescription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="prescriptionVerificationForm" method="post" action="@Url.Action("ProcessVerification", "Prescription")">
                    <input type="hidden" id="prescriptionIdInput" name="PrescriptionId" />
                    <input type="hidden" id="actionInput" name="Action" />

                    <div class="mb-3">
                        <label class="form-label">Decision</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="verificationAction" id="approve" value="Approve" autocomplete="off" checked>
                            <label class="btn btn-outline-success" for="approve">
                                <i class="fas fa-check"></i> Approve
                            </label>

                            <input type="radio" class="btn-check" name="verificationAction" id="reject" value="Reject" autocomplete="off">
                            <label class="btn btn-outline-danger" for="reject">
                                <i class="fas fa-times"></i> Reject
                            </label>

                            <input type="radio" class="btn-check" name="verificationAction" id="requestInfo" value="RequestInfo" autocomplete="off">
                            <label class="btn btn-outline-warning" for="requestInfo">
                                <i class="fas fa-question"></i> Request Info
                            </label>
                        </div>
                    </div>

                    <div id="commentsSection" class="mb-3">
                        <label for="commentsInput" class="form-label">Comments</label>
                        <textarea id="commentsInput" name="Comments" class="form-control" rows="3"
                                  placeholder="Add any comments about this prescription..."></textarea>
                    </div>

                    <div id="requestDetailsSection" class="mb-3 d-none">
                        <label for="requestDetailsInput" class="form-label">Request Details</label>
                        <textarea id="requestDetailsInput" name="RequestDetails" class="form-control" rows="3"
                                  placeholder="Specify what additional information you need from the customer..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="submitVerificationBtn" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // View prescription
            $('.view-prescription').on('click', function() {
                const prescriptionUrl = $(this).data('prescription-url');
                const prescriptionId = $(this).data('prescription-id');

                // Determine if it's a PDF or image
                const isPdf = prescriptionUrl.toLowerCase().endsWith('.pdf');

                // Show appropriate container
                if (isPdf) {
                    $('#prescriptionPdfContainer').removeClass('d-none');
                    $('#prescriptionImageContainer').addClass('d-none');
                    $('#prescriptionPdf').attr('src', prescriptionUrl);
                } else {
                    $('#prescriptionImageContainer').removeClass('d-none');
                    $('#prescriptionPdfContainer').addClass('d-none');
                    $('#prescriptionImage').attr('src', prescriptionUrl);
                }

                // Set download link
                $('#prescriptionDownloadBtn').attr('href', '@Url.Action("Download", "Prescription")/' + prescriptionId);

                $('#prescriptionViewModal').modal('show');
            });

            // Verify prescription
            $('.verify-prescription').on('click', function() {
                const prescriptionId = $(this).data('prescription-id');
                $('#prescriptionIdInput').val(prescriptionId);
                $('#verificationModal').modal('show');
            });

            // Show/hide request details based on action selection
            $('input[name="verificationAction"]').change(function() {
                if ($(this).val() === 'RequestInfo') {
                    $('#requestDetailsSection').removeClass('d-none');
                } else {
                    $('#requestDetailsSection').addClass('d-none');
                }
            });

            // Submit verification form
            $('#submitVerificationBtn').on('click', function() {
                const action = $('input[name="verificationAction"]:checked').val();
                $('#actionInput').val(action);

                // Validate form based on selected action
                let isValid = true;

                if (action === 'Reject' && $('#commentsInput').val().trim() === '') {
                    alert('Please provide a reason for rejection.');
                    isValid = false;
                }

                if (action === 'RequestInfo' && $('#requestDetailsInput').val().trim() === '') {
                    alert('Please specify what additional information you need.');
                    isValid = false;
                }

                if (isValid) {
                    $('#prescriptionVerificationForm').submit();
                }
            });
        });
    </script>
}